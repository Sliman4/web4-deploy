#!/usr/bin/env node

const { Web3Storage } = require('web3.storage')

const CID = require('cids');
const { connect, keyStores, Account, KeyPair, transactions } = require('near-api-js');

const path = require('path');
const fs = require('fs');
const fetch = require('node-fetch');

const { CarReader } = require('@ipld/car');
const { packToFs } = require('ipfs-car/pack/fs');

const { deployNEARFS } = require('../src/util/nearfs.js');
const { checkIPFSGateways } = require('../src/util/gateway-check.js');

const meow = require('meow');

const cli = meow(`
    Usage:

        web4-deploy <src-directory> <destination-account.near>

    Options:

        --deployContract [contract-name]   Deploy contract to the account.
            If contract name is not provided, default contract gonna be deployed: https://github.com/vgrichina/web4-min-contract

        --nearfs                           Deploy to NEARFS instead of IPFS. Enabled by default.
            See more details on https://github.com/vgrichina/nearfs

        --estuary                          Use Estuary for IPFS pinning.
        --web3-storage                     Use web3.storage for IPFS pinning.
        --yes                              Skip confirmation prompt.

        --help                             Show this help message.

        --version                          Show package version.
`, {
    flags: {
        deployContract: {
            type: 'string',
        },
        nearfs: {
            type: 'boolean',
            default: true,
        },
        estuary: {
            type: 'boolean',
        },
        web3Storage: {
            type: 'boolean',
        },
        help: {
            type: 'boolean',
        },
        version: {
            type: 'boolean',
        }
    },
    allowUnknownFlags: false
});

if (cli.input.length !== 2 || cli.flags.help) {
    cli.showHelp(1);
}

deploy(cli);

async function deploy(cli) {
    const WEB3_TOKEN = process.env.WEB3_TOKEN;
    const ESTUARY_TOKEN = process.env.ESTUARY_TOKEN;

    if (cli.flags.web3Storage && !WEB3_TOKEN) {
        console.error(`
You need to set WEB3_TOKEN environment variable to allow IPFS pinning.

WEB3_TOKEN environment variable needs to be set to your web3.storage API token.
See https://web3.storage/docs/how-tos/generate-api-token/ for more information.

`);
    }

    if (cli.flags.estuary && !ESTUARY_TOKEN) {
        console.error(`
You need to set ESTUARY_TOKEN environment variable to allow IPFS pinning.

ESTUARY_TOKEN environment variable needs to be set to your Estuary API token.
See http://docs.estuary.tech/tutorial-get-an-api-key for more information.

`);
    }

    const [ dir, accountId ] = cli.input;

    const NEAR_SIGNER_ACCOUNT = process.env.NEAR_SIGNER_ACCOUNT || accountId;
    const NEAR_SIGNER_KEY = process.env.NEAR_SIGNER_KEY;

    async function connectNEAR() {
        const config = require('../src/config')(process.env.NEAR_ENV || process.env.NODE_ENV);
        const keyStore = NEAR_SIGNER_KEY ? new keyStores.InMemoryKeyStore() : new keyStores.UnencryptedFileSystemKeyStore(`${process.env.HOME}/.near-credentials`);
        if (NEAR_SIGNER_KEY) {
            keyStore.setKey(config.networkId, NEAR_SIGNER_ACCOUNT, KeyPair.fromString(NEAR_SIGNER_KEY));
        }
        const near = await connect({
            ...config,
            keyStore
        })
        const account = new Account(near.connection, NEAR_SIGNER_ACCOUNT);
        return { config, keyStore, near, account };
    }

    const { config, account } = await connectNEAR();

    console.log('Packaging files into a CAR file...');
    const tmpDir = fs.mkdtempSync('web4-deploy-');
    const carFile = `${tmpDir}/deploy.car`;
    // NOTE: packToBlob seems to pack raw input string instead of files? TODO: Figure out how to avoid tmp file
    const { root } = await packToFs({ input: dir, output: carFile, wrapWithDirectory: false });
    const carBuffer = Buffer.from(fs.readFileSync(carFile));
    fs.rmSync(tmpDir, { recursive: true });

    const carReader = await CarReader.fromBytes(carBuffer);

    if (cli.flags.estuary) {
        console.log('Uploading CAR file to Estuary...');
        const addCar = await fetch('https://api.estuary.tech/content/add-car', {
            headers: {
                'Authorization': `Bearer ${ESTUARY_TOKEN}`,
            },
            method: 'POST',
            body: carBuffer
        });

        if (!addCar.ok) {
            console.error('Error:', await addCar.text());
            throw new Error('Failed to upload CAR file to Estuary');
        }
    }

    if (cli.flags.web3Storage) {
        console.log('Uploading CAR file to web3.storage...')
        const storage = new Web3Storage({ token: WEB3_TOKEN })
        await storage.putCar(carReader);
    }

    if (cli.flags.nearfs) {
        await deployNEARFS(account, carBuffer, cli);
    }

    if (!cli.flags.nearfs && !cli.flags.estuary && !cli.flags.web3Storage) {
        console.error('No IPFS pinning service configured. Use one of following options: --nearfs, --estuary, --web3-storage');
        process.exit(1);
    }

    const rootCID32 = new CID(root.toString()).toV1().toString('base32');
    const cids = [];
    for await (const cid of carReader.cids()) {
        cids.push(new CID(cid.toString()).toV1().toString('base32'));
    }

    if (cli.flags.estuary || cli.flags.web3Storage) {
        await checkIPFSGateways(cids);
    }

    if (cli.flags.deployContract != undefined) {
        await deployContract(account, cli.flags.deployContract);
    }

    const url = `ipfs://${rootCID32}`;
    console.log('\nUpdating static url', url);

    try {
        const { transaction: { hash } } = await account.functionCall(accountId, 'web4_setStaticUrl', { url });
        console.log('Updated in transaction:', `${config.explorerUrl}/transactions/${hash}`);
        console.log('\nVisit your website at:', `https://${accountId.replace(/^web4./, '')}.page`);
    } catch (e) {
        if (e.message.includes('Cannot find contract code for account')) {
            console.log(`
Account ${account.accountId} doesn't have a contract deployed yet.
Please deploy contract first using --deploy-contract option.

Example:

    web4-deploy ${dir} ${account.accountId} --deploy-contract ./out/main.wasm


You can use default contract as well:

    web4-deploy ${dir} ${account.accountId} --deploy-contract

This going to deploy mimimal contract which just sets static url to the one provided.
See https://github.com/vgrichina/web4-min-contract.

            `);
            process.exit(1);
        }

        throw e;
    }
}

async function deployContract(account, contractPath) {
    console.log('Deploying contract...');
    // NOTE: This contract is taken from https://github.com/vgrichina/web4-min-contract
    contractPath = contractPath || path.resolve(__dirname, '../data/web4-min.wasm');
    const contract = fs.readFileSync(contractPath);

    await account.deployContract(contract);
}